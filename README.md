# ðŸŒ¸ FreeRTOSå­¦ä¹ æ—¥å¿— 

âœ¨ *"å‘~ä»Šå¤©ä¹Ÿè¦å…ƒæ°”æ»¡æ»¡åœ°å†™ä»£ç å“¦ï¼"* âœ¨

---

## ðŸš€ ä»Šæ—¥è¿›å±•
æˆåŠŸåœ¨STM32ä¸Šå®Œæˆï¼š
- ðŸ§µ **FreeRTOSç§»æ¤**ï¼ˆçŽ°åœ¨å¯ä»¥æ„‰å¿«åœ°å¤šçº¿ç¨‹å•¦~ï¼‰
- ðŸŽ® **ä»»åŠ¡åˆ›å»º**  
  - åŠ¨æ€åˆ›å»º `xTaskCreate()` (*åƒæ³¡æ³¡ä¸€æ ·éšæ—¶å‡ºçŽ°*)  
  - é™æ€åˆ›å»º `xTaskCreateStatic()` (*åƒä¹é«˜ç§¯æœ¨ä¸€æ ·ç¨³å›º*)
- â¸ï¸ **ä»»åŠ¡ç®¡ç†**  
  - ç”¨`vTaskSuspend()`è®©ä»»åŠ¡ä¹–ä¹–ç¡è§‰  
  - ç”¨`vTaskResume()`å”¤é†’è£…ç¡çš„ä»»åŠ¡ä»¬~   

>"ä»£ç å†ä¸æ‰“å®Œçš„è¯...å°±...å°±å“­ç»™ä½ çœ‹å“¦ï¼(à¹‘â€¢Ì â‚ƒ â€¢Ì€à¹‘)âœ§"
>â€”â€” åœ¨èƒŒåŽå‚¬ä¿ƒçš„VS Codeå§¬

2025å¹´3æœˆ22æ—¥

---
## ðŸŒ¸ FreeRTOSç ”ä¿®æ—¥è®°2

âœ¨ *"ä»Šå¤©çš„ä»£ç ä¹Ÿè¦å…ƒæ°”æ»¡æ»¡åœ°è¿è¡Œå“¦~ (à¹‘>á´—<à¹‘)âœ§"* âœ¨

---

### ðŸš€ ä»Šæ—¥æŠ€èƒ½è§£é”
### â³ **æ—¶é—´ç‰‡è½®è¯¢è°ƒåº¦**
- å­¦ä¼šäº†ç”¨`configUSE_TIME_SLICING = 1`å¼€å¯ç”œèœœåˆ†æ—¶ï½ž  
- ç»™ä»»åŠ¡ä»¬å¹³å‡åˆ†é…ðŸ°æ—¶é—´ç‰‡ï¼ˆé»˜è®¤åŒä¼˜å…ˆçº§è‡ªåŠ¨è½®è½¬ï¼‰
```c
// åƒåˆ†è›‹ç³•ä¸€æ ·é…ç½®ä»»åŠ¡ä¼˜å…ˆçº§
xTaskCreate(task1, "T1", 128, NULL, 2, NULL);  // ðŸŽ‚ä¼˜å…ˆçº§2
xTaskCreate(task2, "T2", 128, NULL, 2, NULL);  // ðŸ§åŒä¼˜å…ˆçº§è‡ªåŠ¨è½®æ¢
```
### ðŸ“Š ä»»åŠ¡çŠ¶æ€ä¾¦æŸ¥æœ¯
- å¬å”¤uxTaskGetSystemState()èŽ·å–å…¨å‘˜çŠ¶æ€å¿«ç…§
- ä½¿ç”¨vTaskList()ç”ŸæˆASCIIè‰ºæœ¯æŠ¥è¡¨   

### ðŸ¾ è¸©åˆ°BUGå°å¼º
```c
// (â•¯â€µâ–¡â€²)â•¯ å½“å¿˜è®°ç»™vTaskListåˆ†é…è¶³å¤Ÿå†…å­˜æ—¶...
char bugReport[10]; // å¤ªå°å•¦ï¼
vTaskList(bugReport);  // ðŸ’¥ å†…å­˜æº¢å‡ºâ†’ç³»ç»Ÿæ‰‘è¡—ï¼
```   
### è§£å†³ä¹‹é“ï¼š
- 1ï¸âƒ£ å…ˆç”¨uxTaskGetNumberOfTasks()æ£€æµ‹ä»»åŠ¡æ•°é‡
- 2ï¸âƒ£ åŠ¨æ€åˆ†é…ç¼“å†²åŒºï¼šchar *buf = pvPortMalloc(éœ€è¦çš„é•¿åº¦);   
   

   
2025å¹´3æœˆ23æ—¥   

---    

## ðŸŒ¸ FreeRTOSæ—¶é—´ç®¡ç†ç‰¹è®­

âœ¨ *"ä»»åŠ¡æ‰§è¡Œæ—¶é—´å°±åƒå°‘å¥³çš„å¹´é¾„ï½žè¦å¥½å¥½è®°å½•ä¸‹æ¥å“¦ï¼(à¹‘>á´—<à¹‘)â™¡"* âœ¨



### ðŸš€ ä»Šæ—¥æŠ€èƒ½ç‚¹æ»¡
### â±ï¸ **ä»»åŠ¡æ‰§è¡Œæ—¶é—´å¿«ç…§**

```c
// åœ¨FreeRTOSConfig.hå¬å”¤æ—¶é—´ç²¾çµ
#define configGENERATE_RUN_TIME_STATS  1  // ðŸ§šâ™€ï¸ å¼€å¯æ—¶é—´ç»Ÿè®¡é­”æ³•
#define configUSE_STATS_FORMATTING_FUNCTIONS 1  // ðŸ“Š è§£é”æŠ¥è¡¨æ ¼å¼è½¬æ¢

// åœ¨stm32ä¸­é…ç½®æ—¶é—´ç»Ÿè®¡ä¸“ç”¨å®šæ—¶å™¨ï¼ˆå¦‚TIM2ï¼‰
void ConfigureTimeStatsTimer() {
    __HAL_RCC_TIM2_CLK_ENABLE();
    TIM2->PSC = SystemCoreClock/1000000 -1;  // 1usç²¾åº¦âœ¨
    TIM2->ARR = 0xFFFFFFFF;  // 32ä½è‡ªç”±å¥”è·‘æ¨¡å¼
    HAL_TIM_Base_Start(&htim2);
}
```
### â° å»¶æ—¶é­”æ³•å¯¹æ¯”è¡¨   
| é­”æ³•ç±»åž‹ | å’’è¯­  | ç‰¹æ€§  | ä½¿ç”¨åœºæ™¯ |
| :---    | :--: | :--: | ---:   |
| ç›¸å¯¹å»¶æ—¶ | vTaskDelay()  | ä»Žå½“å‰å¼€å§‹è®¡ç®—  | ç®€å•å»¶æ—¶ |
| ç»å¯¹å»¶æ—¶ | xTaskDelayUntil()  | ä¿æŒå›ºå®šå‘¨æœŸ(é˜²ç´¯ç§¯è¯¯å·®)  | å¿ƒè·³ä»»åŠ¡/ç²¾ç¡®å‘¨æœŸ |   
```c
// ç»å¯¹å»¶æ—¶ã®æ­£ç¡®å§¿åŠ¿
TickType_t xLastWakeTime = xTaskGetTickCount();
while(1) {
    LED_Toggle();
    xTaskDelayUntil(&xLastWakeTime, pdMS_TO_TICKS(100));  // ç²¾ç¡®100mså‘¨æœŸâœ¨
}

```   
### ðŸ¾ æŽ‰è¿›æ—¶é—´æ¼©æ¶¡
```c
// (â•¯Â°â–¡Â°ï¼‰â•¯ å½“å¿˜è®°å¯åŠ¨ç»Ÿè®¡å®šæ—¶å™¨æ—¶...
void vTaskGetRunTimeStats(char *pcBuffer);  
// è¾“å‡ºï¼šå…¨ä»»åŠ¡è¿è¡Œæ—¶é—´éƒ½æ˜¯0%ï¼ðŸ’¢

// ç»å¯¹å»¶æ—¶çš„å±é™©æ“ä½œ
xLastWakeTime += pdMS_TO_TICKS(100);  // æ‰‹åŠ¨ä¿®æ”¹åŸºå‡†æ—¶é—´â†’æ—¶é—´çº¿å´©åï¼

```   
**è§£å†³æ–¹æ¡ˆï¼š**

- ç”¨CubeMXé…ç½®ä¸“ç”¨å®šæ—¶å™¨å¹¶è‡ªåŠ¨å¯åŠ¨

- æ°¸è¿œè®©xTaskDelayUntil()è‡ªå·±ç®¡ç†åŸºå‡†æ—¶é—´ï½ž   

### ðŸ“Š æ—¶é—´ç»Ÿè®¡æŠ¥è¡¨èŒƒä¾‹
```text
ä»»åŠ¡å  çŠ¶æ€   ä¼˜å…ˆçº§  å‰©ä½™æ ˆ  è¿è¡Œæ—¶é—´(%)  
LED     R     1       88      12.3%  
UART    B     2       120     45.6%  
IDLE    R     0       64      42.1%   ðŸ‘»
```
>*IDLEå›åˆåœ¨å·å·æ‘¸é±¼å•¦ï½žï¼‰*   

>"ç»å¯¹å»¶æ—¶å°±åƒçº¦ä¼šæ—¶é—´ï½žè¿Ÿåˆ°çš„è¯ä¼šè¢«å…¶ä»–ä»»åŠ¡NTRçš„å“¦ï¼(à¹‘â€¢Ì â‚ƒ â€¢Ì€à¹‘)"
>â€”â€” çœ‹ç€è°ƒåº¦å™¨çš„VS Codeå§¬      


2025å¹´3æœˆ24æ—¥   

--- 


## ðŸŒ¸ FreeRTOSé€šä¿¡ä¸ŽåŒæ­¥ä¿®è¡Œ 

âœ¨ *"é˜Ÿåˆ—æ˜¯ä»»åŠ¡é—´çš„å°ä¿¡ç®±ï¼Œä¿¡å·é‡æ˜¯èµ„æºçš„å°é—¨å«ï½žè¦å¥½å¥½ç›¸å¤„å“¦ï¼(à¹‘>á´—<à¹‘)â™¡"* âœ¨


### ðŸš€ ä»Šæ—¥æŠ€èƒ½è§‰é†’
### ðŸ“® **é˜Ÿåˆ—ï¼ˆQueueï¼‰çš„å¥‡å¦™é‚®å±€**
```c
// åˆ›å»ºèƒ½å­˜æ”¾10ä¸ªæ•´æ•°çš„é‚®ç®±
QueueHandle_t xMailbox = xQueueCreate(10, sizeof(int32_t));

// ä»»åŠ¡Aå¯„ä¿¡ï¼ˆéžé˜»å¡žå‘é€ï¼‰
int32_t loveLetter = 520;
xQueueSend(xMailbox, &loveLetter, 0);  // âœ‰ï¸ ç«‹åˆ»æŠ•é€’ï¼

// ä»»åŠ¡Bæ”¶ä¿¡ï¼ˆæœ€å¤šç­‰100msï¼‰
int32_t receivedData;
if(xQueueReceive(xMailbox, &receivedData, pdMS_TO_TICKS(100)) {
    printf("æ”¶åˆ°è¡¨ç™½ï¼š%d\n", receivedData);  // ðŸ’Œ
}
```

### ðŸ” **ä¿¡å·é‡å®¶æ—å¯¹æ¯”è¡¨**
| ç±»åž‹                | é­”æ³•å’’è¯­                  | åº”ç”¨åœºæ™¯                      | ç‰¹ç‚¹                     |
|---------------------|--------------------------|-----------------------------|--------------------------|
| **äºŒè¿›åˆ¶ä¿¡å·é‡**     | xSemaphoreCreateBinary() | ä»»åŠ¡åŒæ­¥/äº’æ–¥è®¿é—®            | åªæœ‰0/1ä¸¤ç§çŠ¶æ€          |
| **è®¡æ•°åž‹ä¿¡å·é‡**     | xSemaphoreCreateCounting(5,0)| èµ„æºæ± ç®¡ç†ï¼ˆå¦‚å†…å­˜å—ï¼‰       | å¯è®°å½•å¯ç”¨èµ„æºæ•°é‡       |

```c
// äºŒè¿›åˆ¶ä¿¡å·é‡ï¼ˆåƒåŽ•æ‰€é’¥åŒ™ðŸ”‘ï¼‰
SemaphoreHandle_t xBathroomKey = xSemaphoreCreateBinary();
xSemaphoreGive(xBathroomKey);  // åˆå§‹çŠ¶æ€è®¾ä¸ºå¯ç”¨

// ä»»åŠ¡ä½¿ç”¨åŽ•æ‰€ï¼ˆèŽ·å–ä¿¡å·é‡ï¼‰
if(xSemaphoreTake(xBathroomKey, portMAX_DELAY)) {
    printf("ðŸš½ æ­£åœ¨ä½¿ç”¨åŽ•æ‰€...\n");
    xSemaphoreGive(xBathroomKey);  // è®°å¾—è¿˜é’¥åŒ™ï¼
}

// è®¡æ•°åž‹ä¿¡å·é‡ï¼ˆå¦‚åœè½¦åœºðŸ…¿ï¸ï¼‰
SemaphoreHandle_t xParkingLot = xSemaphoreCreateCounting(5,5);  // 5ä¸ªè½¦ä½
xSemaphoreTake(xParkingLot, 0);  // å ç”¨1ä¸ªè½¦ä½
```

---

### ðŸ¾ æŽ‰è¿›åŒæ­¥é™·é˜±
```c
// (â•¯Â°â–¡Â°ï¼‰â•¯ å¿˜è®°é‡Šæ”¾ä¿¡å·é‡å¯¼è‡´æ­»é”ï¼
xSemaphoreTake(xBathroomKey, portMAX_DELAY);  
printf("ç”¨å®ŒåŽ•æ‰€ä½†å¿˜è®°è¿˜é’¥åŒ™ï¼\n");  
// å…¶ä»–ä»»åŠ¡æ°¸è¿œç­‰ä¸åˆ°åŽ•æ‰€å•¦ï¼ðŸ’¥

// é˜Ÿåˆ—æº¢å‡ºæƒ¨æ¡ˆ
int32_t bigData[100];
xQueueSend(xMailbox, bigData, 0);  // ðŸ’£ å‘é€çš„æ•°æ®è¶…è¿‡é˜Ÿåˆ—å•å…ƒå¤§å°ï¼
```
**é¿å‘æŒ‡å—**ï¼š  
1. ç”¨`uxQueueSpacesAvailable()`æ£€æŸ¥é˜Ÿåˆ—å‰©ä½™ç©ºé—´  
2. å°†ä¿¡å·é‡æ“ä½œæ”¾å…¥`taskENTER_CRITICAL()`ä¿æŠ¤åŒºåŸŸ  
3. ä½¿ç”¨Staticç‰ˆæœ¬APIé˜²æ­¢å†…å­˜æ³„æ¼  



2025å¹´3æœˆ25æ—¥   

---

## ðŸŒ¸ FreeRTOSé«˜çº§åŒæ­¥æœ¯ 

âœ¨ *"äº’æ–¥é”æ˜¯èµ„æºçš„VIPé€šé“ï¼Œäº‹ä»¶ç»„æ˜¯ä»»åŠ¡é—´çš„æ‘©æ–¯å¯†ç ï½žè¦ä¼˜é›…åœ°ä½¿ç”¨å“¦ï¼(à¹‘>á´—<à¹‘)â™¡"* âœ¨

---

### ðŸš€ ä»Šæ—¥æŠ€èƒ½è§‰é†’
### ðŸ”’ **äº’æ–¥é”ï¼ˆMutexï¼‰çš„è´µæ—ç¤¼ä»ª**
```c
// åˆ›å»ºé«˜è´µçš„äº’æ–¥é”ï¼ˆå¸¦ä¼˜å…ˆçº§ç»§æ‰¿ï¼ï¼‰
SemaphoreHandle_t xVIPé€šé“ = xSemaphoreCreateMutex();

// ä»»åŠ¡è®¿é—®å…±äº«èµ„æº
if(xSemaphoreTake(xVIPé€šé“, pdMS_TO_TICKS(100))) {
    printf("ðŸŽ© è¿›å…¥VIPåŒºæ“ä½œSDå¡...\n");
    xSemaphoreGive(xVIPé€šé“);  // ä¼˜é›…å½’è¿˜
} else {
    printf("â³ ç­‰å¾…è¶…æ—¶ï¼Œç¤¼è²Œç¦»å¼€ï½ž\n");
}
```

### ðŸ“­ **é˜Ÿåˆ—é›†ï¼ˆQueueSetï¼‰çš„å¤šè·¯ç›‘å¬**
```c
// åˆ›å»ºèƒ½ç›‘æŽ§3ä¸ªé˜Ÿåˆ—çš„ç›‘å¬ç«™
QueueSetHandle_t xç›‘è§†ç«™ = xQueueCreateSet(3);

// å°†é˜Ÿåˆ—å’Œä¿¡å·é‡åŠ å…¥ç›‘å¬
xQueueAddToSet(xUARTé˜Ÿåˆ—, xç›‘è§†ç«™);
xQueueAddToSet(xä¼ æ„Ÿå™¨ä¿¡å·é‡, xç›‘è§†ç«™);

// ç­‰å¾…ä»»æ„äº‹ä»¶è§¦å‘
QueueSetMemberHandle_t xæ¿€æ´»æˆå‘˜ = xQueueSelectFromSet(xç›‘è§†ç«™, portMAX_DELAY);
if(xæ¿€æ´»æˆå‘˜ == xUARTé˜Ÿåˆ—) {
    // å¤„ç†UARTæ•°æ®
}
```

### ðŸš© **äº‹ä»¶æ ‡å¿—ç»„çš„ä½æ“ä½œé­”æ³•**
```c
// åˆ›å»ºåŒ…å«8ä¸ªæ ‡å¿—ä½çš„äº‹ä»¶ç»„
EventGroupHandle_t xæ‘©æ–¯å¯†ç æœ¬ = xEventGroupCreate();

// ä»»åŠ¡Aå‘é€äº‹ä»¶ï¼ˆç½®ä½BIT0å’ŒBIT1ï¼‰
xEventGroupSetBits(xæ‘©æ–¯å¯†ç æœ¬, (1<<0)|(1<<1));  // âœ¨ å‘é€ä¿¡å·

// ä»»åŠ¡Bç­‰å¾…ç‰¹å®šç»„åˆ
EventBits_t uxæ”¶åˆ°ä¿¡å· = xEventGroupWaitBits(
    xæ‘©æ–¯å¯†ç æœ¬, 
    (1<<0)|(1<<1),  // è¦ç­‰å¾…çš„ä½
    pdTRUE,         // ç­‰å¾…åŽæ¸…é™¤è¿™äº›ä½
    pdTRUE,         // è¦æ±‚æ‰€æœ‰ä½åŒæ—¶æ»¡è¶³
    portMAX_DELAY
);
```

---

### ðŸ¾ åŒæ­¥ç¾éš¾çŽ°åœº
```c
// (â•¯Â°â–¡Â°ï¼‰â•¯ äº’æ–¥é”åµŒå¥—å¯¼è‡´æ­»é”ï¼
xSemaphoreTake(xMutex1, portMAX_DELAY);
xSemaphoreTake(xMutex2, portMAX_DELAY);  // ðŸ’€ å…¶ä»–ä»»åŠ¡å¯èƒ½ä»¥ç›¸åé¡ºåºèŽ·å–

// äº‹ä»¶æ ‡å¿—ä½æº¢å‡ºæ‚²å‰§
xEventGroupSetBits(xç»„, 0xFF<<24);  // è¶…è¿‡24ä½ï¼æŸäº›å¹³å°ä¼šæˆªæ–­ðŸ’¥
```
**é¿å‘æŒ‡å—**ï¼š  
1. ä½¿ç”¨`xSemaphoreGetMutexHolder()`æ£€æµ‹æ­»é”  
2. äº‹ä»¶æ ‡å¿—ç»„ç”¨`configUSE_16_BIT_TICKS`æŽ§åˆ¶ä½æ•°  
3. é˜Ÿåˆ—é›†ç›‘å¬æˆå‘˜ä¸è¦è¶…è¿‡`configQUEUE_SET_LENGTH`  
    

    
2025å¹´3æœˆ26æ—¥

---




